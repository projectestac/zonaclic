-----------------------------------------------------------.------------------
=== Preparació de l'entorn de desenvolupament amb NetBeans i Apache Tomcat ===
------------------------------------------------------------------------------

ACTUALITZAT OCT2012: Provat amb NetBeans 7.2 i Apache Tomcat 7.0
ACTUALITZAT NOV2016: Provat amb NetBeans 8.1 i Apache Tomcat 8.0

IMPORTANT: En tot aquest document cal substituir l'expressió "$HOME" pel directori d'inici de l'usuari que estigui
implementant l'entorn de desenvolupament. A tot arreu on aparegui l'expressió $HOME s'ha de substituir pel
path corresponent. EN CAP CAS S'HA D'ESCRIURE "$HOME"!!!

IMPORTANT: També fem servir l'expressió "$ROOT" per referir-nos al directori arrel des d'on pengen tots els
fitxers amb el codi font i la documentació. Normalment aquest directori correspondrà a la branca master de
"projectestac/jclic" a github.com

1 - Preparar la base de dades Oracle tal com s'explica a config-oracle.txt

2 - Fer un "git clone" a https//github.com/projectestac/jclic.git per obtenir els fitxers del directori $ROOT

3 - Copiar tots els fitxers ".properties" del directori $ROOT/home al directori $HOME de l'usuari

4 - Definir el host "clic-virtual.xtec.cat" com a sinònim de "localhost" a 127.0.0.1.
    A la Linkat això es fa afegint aquesta línia a /etc/hosts:

    127.0.0.1       clic-virtual.xtec.cat

5 - Instal·lar una versió de NetBeans 6.x o superior que inclogui "Java web" i "Apache Tomcat". Es pot descarregar des de:
    http://netbeans.org/downloads/index.html

6 - Engegar Netbeans i configurar-lo per tal que faci servir el servidor Apache Tomcat.
    Configurar Tomcat per treballar pel port 8084 (el 8080 està ocupat per Oracle XE)

7 - Posar en marxa per primera vegada Apache Tomcat des de Netbeans:
    pestanya "Services", "Servers", "Apache Tomcat", clic dreta, "Start"

    S'haurà creat un directori ocult ".netbeans" dins de $HOME. Algunes de les modificacions que s'expliquen
    tot seguit s'han de fer en fitxers que es troben dins d'aquest directori.
    A les instruccions cal substituir "xx" pel número de versió corresponent.

8 - Modificar manualment el fitxer:
    $HOME/.nebeans/6.x/apache-tomcat-xx_base/conf/Catalina/localhost/ROOT.xml
    ...per tal que tingui aquest contingut:

<Context path="" docBase="$ROOT/web" allowLinking="true"/>

ATENCIÓ: Recordeu substituir l'expressió $ROOT del docBase pel seu path absolut!

9 - Crear un fitxer anomenat "context.xml.default" a:
    $HOME/.nebeans/6.x/apache-tomcat-xxx_base/conf/Catalina/localhost
    ...amb aquest contingut:

<Context allowLinking="true">
<Resource name="jdbc/ClicConnectionPoolDS"
          auth="Container"
          type="javax.sql.DataSource" 
          driverClassName="oracle.jdbc.OracleDriver" 
          url="jdbc:oracle:thin:@(DESCRIPTION=(LOAD_BALANCE=on)(ADDRESS=(PROTOCOL=TCP)(HOST=localhost)(PORT=1521))(CONNECT_DATA=(SERVER=DEDICATED)(SERVICE_NAME=XE)))"
          username="clic"
          password="clic"
          maxActive="20"
          maxIdle="10"
          maxWait="-1"/>
</Context>

ATENCIÓ: Potser caldrà substituir "localhost" per la IP del servidor on estigui funcionant l'oracleXE

9 - Assegurar-se que el driver JDBD d'Oracle (fitxer $ROOT/oracle/jdbc/ojdbc14.jar) es trobi al
    classpath de Tomcat. Això es pot aconseguir copiant-lo a $JAVA_HOME/lib/ext o a la carpeta "lib" de 
    la instal·lació de Tomcat (que en el cas de la Linkat és /usr/local/apache-tomcat-xxx/lib)

    ACTUALITZACIÓ: En Ubuntu, el fitxer es pot deixar (o millor enllaçar) a /usr/java/packages/lib/ext
    ACTUALITZACIÓ: Amb Tomca 8 cal que el driver sigui com a mínim el de Oracle11g (fitxer ojdbc6.jar - http://download.oracle.com/otn/utilities_drivers/jdbc/121010/ojdbc6.jar)

10 - Copiar el fitxer:
     $ROOT/lib/jclicreports.war
     a:
     $HOME/.nebeans/xxx/apache-tomcat-xxx_base/webapps

11 - Tornar a Netbeans (pestanya "Services" - "Servers") i fer un "restart" del servidor Apache.
     Comprovar que en obrir l'URL http://clic-virtual.xtec.cat:8084/index.htm es pugui navegar per la primera pàgina
     de la seció "català". És normal que faltin algunes imatges pàgines, perquè a l'entorn de
     desenvolupament s'hi ha copiat només una part de la web.

11 - Crear un nou "Project group" a Netbeans, anomenat "zonaClic":
     "File - Project Group - New Group..."

12 - Obrir ("File - Open project") aquests tres projectes:

     $ROOT/netbeans/clicDB
     $ROOT/netbeans/JNLPServlet
     $ROOT/netbeans/gali

13 - Desplegar les tres aplicacions. Per cada una:
     > Seleccionar l'aplicació
     > Clic amb el botó dret
     > "Deploy"
     L'aplicació "jclicreports" es desplegarà sola, ja que abans hem copiat el fitxer "war" a webapps.

14 - Reiniciar el servidor Apache des de Netbeans.
     Per comprovar el funcionament es poden invocar els següents URL:
     - WebClic estàtic: http://clic-virtual.xtec.cat:8084/
     - WebClic dinàmic: http://clic-virtual.xtec.cat:8084/db/
     - Galí: http://clic-virtual.xtec.cat:8084/gali/
     - JNLP:
       http://clic-virtual.xtec.cat:8084/jnlp/jclic/player.jnlp (engega el JClic amb Java WebStart)
       http://clic-virtual.xtec.cat:8084/jnlp/jclic/author.jnlp (engega el JClic Author amb Java WebStart)
     - Provar l'instal·lador d'algun dels primers projectes de la llista mostrada al portal

ATENCIÓ: La compilacó de les versions que s'envien als entorns d'integració, acceptació i producció s'ha de fer
mitjançant línia d'ordres, situant-se a la carpeta $ROOT i escrivint "ant"

